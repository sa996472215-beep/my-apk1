<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>â° ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
<meta name="theme-color" content="#667eea">
<link rel="manifest" href="#manifest-placeholder">
<style>
:root{
  --bg:linear-gradient(135deg,#667eea,#764ba2);
  --card:#ffffff;
  --text:#000;
  --accent:#4CAF50;
  --danger:#f44336;
  --warning:#ff9800;
  --info:#2196F3;
  --primary:#667eea;
  --success:#4CAF50;
  --upcoming:#4CAF50;   /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø© */
  --soon:#ff9800;       /* Ø£ØµÙØ± Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© */
  --overdue:#f44336;    /* Ø£Ø­Ù…Ø± Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© */
}
.dark{
  --bg:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  --card:#1e1e1e;
  --text:#fff;
}

body{
  margin:0;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:var(--bg);
  color:var(--text);
  direction:rtl;
  min-height:100vh;
  padding:0;
  box-sizing:border-box;
  transition:background 0.3s ease;
  overflow-x:hidden;
  position:relative;
}

.topbar{
  background:rgba(0,0,0,.25);
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
  font-weight:600;
  position:sticky;
  top:0;
  box-shadow:0 2px 10px rgba(0,0,0,.2);
  z-index:100;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
  flex-wrap:wrap;
  width:100%;
}

.toggle{
  background:#000;
  border:none;
  width:38px;
  height:38px;
  border-radius:50%;
  color:#fff;
  cursor:pointer;
  transition:all 0.3s ease;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
}

.toggle:hover{
  transform:rotate(180deg);
  background:#333;
}

.tab-container{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  min-width:0;
  flex:1;
  overflow-x:auto;
  padding:5px 0;
  scrollbar-width:none;
}

.tab-container::-webkit-scrollbar{
  display:none;
}

.tab-btn{
  background:rgba(255,255,255,0.2);
  border:none;
  color:white;
  padding:8px 15px;
  border-radius:20px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s;
  white-space:nowrap;
  min-width:100px;
  flex-shrink:0;
}

.tab-btn.active{
  background:rgba(255,255,255,0.4);
  transform:scale(1.05);
}

.tab-btn:hover:not(.active){
  background:rgba(255,255,255,0.3);
}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  padding:20px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  transition:all 0.3s ease;
  width:95%;
  box-sizing:border-box;
  margin-top:10px;
}

.field{
  margin-bottom:15px;
}

.field label{
  display:block;
  font-size:15px;
  margin-bottom:6px;
  font-weight:600;
  color:var(--text);
}

input,textarea,select,button{
  width:100%;
  margin:0;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:15px;
  box-sizing:border-box;
  font-family:inherit;
}

input:focus,textarea:focus,select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(76, 175, 80, 0.2);
}

button{
  background:var(--accent);
  color:white;
  cursor:pointer;
  transition:.3s;
  margin-top:10px;
  border:none;
  font-weight:600;
  font-size:16px;
  padding:14px;
}
button:hover{transform:scale(1.03); box-shadow:0 4px 15px rgba(0,0,0,.2)}

.record{
  background:var(--info);
  margin-top:0;
}

.record:hover{
  transform:scale(1.03);
}

.item{
  background:rgba(0,0,0,.05);
  padding:14px;
  border-radius:12px;
  margin-top:12px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  transition:all 0.3s ease;
  position:relative;
  border-left:4px solid var(--accent);
}

.item:hover{
  transform:translateX(5px);
  box-shadow:0 3px 12px rgba(0,0,0,.15);
}

.dark .item{background:rgba(255,255,255,.08)}

.item.done{
  opacity:0.6;
  background:rgba(76, 175, 80, 0.1);
}

.item.upcoming {
  border-left-color: var(--upcoming);
}

.item.soon {
  border-left-color: var(--soon);
}

.item.overdue {
  border-left-color: var(--overdue);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
  70% { box-shadow: 0 0 0 8px rgba(244, 67, 54, 0); }
  100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
}

.delete, .edit, .done-btn, .snooze-btn{
  border:none;
  padding:6px 10px;
  color:white;
  border-radius:8px;
  cursor:pointer;
  transition:all 0.2s;
  font-size:16px;
  min-width:36px;
  margin-left:5px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:5px;
}

.delete{
  background:var(--danger);
}
.delete:hover{
  background:#d32f2f;
  transform:scale(1.1);
}

.edit{
  background:var(--warning);
}
.edit:hover{
  background:#e65100;
  transform:scale(1.1);
}

.done-btn{
  background:var(--success);
}
.done-btn:hover{
  background:#2e7d32;
  transform:scale(1.1);
}

.snooze-btn{
  background:var(--info);
}
.snooze-btn:hover{
  background:#0d47a1;
  transform:scale(1.1);
}

.time-display{
  color:#666;
  font-size:13px;
  margin-top:4px;
}

.dark .time-display{
  color:#aaa;
}

.alert{
  padding:12px;
  border-radius:10px;
  margin:10px 0;
  font-size:14px;
  text-align:center;
  font-weight:500;
  animation:slideIn 0.3s ease;
}

@keyframes slideIn{
  from{transform:translateY(-20px); opacity:0}
  to{transform:translateY(0); opacity:1}
}

.alert-success{
  background:rgba(76, 175, 80, 0.2);
  color:#2e7d32;
  border:1px solid #4CAF50;
}

.alert-warning{
  background:rgba(255, 152, 0, 0.2);
  color:#e65100;
  border:1px solid #ff9800;
}

.alert-error{
  background:rgba(244, 67, 54, 0.2);
  color:#c62828;
  border:1px solid #f44336;
}

.recording{
  background:#f44336;
  animation: pulse 1.5s infinite;
}

.ringtones-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));
  gap:12px;
  margin-top:10px;
}

.ringtone-item{
  background:rgba(0,0,0,.05);
  border-radius:12px;
  padding:15px 10px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s;
  border:2px solid transparent;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100px;
}

.dark .ringtone-item{
  background:rgba(255,255,255,.08);
}

.ringtone-item:hover{
  transform:scale(1.03);
  background:rgba(76,175,80,.1);
}

.ringtone-item.selected{
  border-color:var(--accent);
  background:rgba(76,175,80,.15);
  transform:scale(1.05);
  box-shadow:0 0 0 2px var(--accent);
}

.ringtone-item i{
  font-size:28px;
  margin-bottom:8px;
}

.ringtone-item span{
  font-size:13px;
  font-weight:600;
  margin-top:5px;
  display:block;
  min-height:24px;
}

.preview-btn{
  background:var(--info);
  color:white;
  border:none;
  padding:4px 10px;
  border-radius:20px;
  font-size:14px;
  margin-top:5px;
  cursor:pointer;
  transition:all 0.2s;
}

.preview-btn:hover{
  transform:scale(1.1);
  background:#1976d2;
}

.record-section{
  background:rgba(33,150,243,0.1);
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

.record-section h4{
  margin:0 0 10px 0;
  font-size:16px;
  color:var(--info);
  text-align:center;
}

.or-divider{
  text-align:center;
  margin:20px 0;
  position:relative;
}

.or-divider::before{
  content:'Ø£Ùˆ';
  background:var(--card);
  padding:0 15px;
  position:relative;
  z-index:1;
  font-weight:700;
  color:#666;
  font-size:16px;
}

.or-divider::after{
  content:'';
  position:absolute;
  top:50%;
  left:0;
  right:0;
  height:1px;
  background:#ddd;
  z-index:0;
}

.stats{
  display:flex;
  justify-content:space-around;
  margin:15px 0;
  padding:12px;
  background:rgba(0,0,0,.05);
  border-radius:10px;
  font-size:14px;
  font-weight:600;
  flex-wrap:wrap;
  gap:10px;
}

.dark .stats{
  background:rgba(255,255,255,.08);
}

.empty-state{
  text-align:center;
  padding:40px 20px;
  color:#999;
}

.empty-state i{
  font-size:48px;
  display:block;
  margin-bottom:15px;
}

.empty-state p{
  font-size:16px;
  margin:0;
}

.page{
  display:none;
  animation:fadeIn 0.4s ease;
  min-height:calc(100vh - 120px);
  padding-bottom:30px;
  padding-top:10px;
  box-sizing:border-box;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(10px)}
  to{opacity:1; transform:translateY(0)}
}

.page.active{
  display:block;
}

.timer-container {
  text-align: center;
  padding: 15px;
}

.timer-display {
  font-size: 64px;
  font-weight: bold;
  margin: 20px 0;
  color: var(--primary);
  font-family: 'Courier New', monospace;
  text-shadow: 0 2px 5px rgba(0,0,0,0.2);
  letter-spacing: -2px;
}

.timer-controls {
  display: flex;
  gap: 10px;
  margin: 25px 0;
  justify-content: center;
  flex-wrap:wrap;
}

.timer-inputs {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 20px 0;
  flex-wrap:wrap;
}

.timer-input-group {
  text-align: center;
  min-width:80px;
}

.timer-input-group input {
  width: 70px;
  text-align: center;
  font-size: 20px;
  padding: 8px;
}

.timer-input-group label {
  display: block;
  margin-top: 8px;
  font-weight: 500;
  font-size:14px;
}

.timer-btn {
  padding: 14px 20px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 110px;
  white-space:nowrap;
}

.timer-btn.start {
  background: var(--accent);
  color: white;
}

.timer-btn.pause {
  background: var(--warning);
  color: white;
}

.timer-btn.reset {
  background: var(--danger);
  color: white;
}

.timer-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.timer-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.alarm-active {
  animation: pulse 1s infinite;
  box-shadow: 0 0 20px rgba(244, 67, 54, 0.7) !important;
}

.stopwatch-display {
  font-size: 72px;
  font-weight: bold;
  margin: 20px 0;
  color: var(--primary);
  font-family: 'Courier New', monospace;
  text-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.stopwatch-controls {
  display: flex;
  gap: 15px;
  margin: 25px 0;
  justify-content: center;
  flex-wrap:wrap;
}

.laps-container {
  margin-top: 30px;
  max-height: 200px;
  overflow-y: auto;
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.lap-item {
  padding: 10px;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
}

.lap-time {
  font-weight: bold;
  color: var(--primary);
}

/* Search and Filter Styles */
.search-container {
  margin:15px 0;
  position:relative;
}

.search-container input {
  padding-left:40px;
  background:var(--card);
  border:1px solid #ddd;
  width:100%;
}

.search-container i {
  position:absolute;
  left:15px;
  top:50%;
  transform:translateY(-50%);
  color:#888;
  font-size:18px;
}

.filter-container {
  display:flex;
  gap:10px;
  margin:15px 0;
  flex-wrap:wrap;
  justify-content:space-between;
}

.filter-btn {
  background:rgba(0,0,0,0.05);
  border:1px solid #ddd;
  padding:8px 15px;
  border-radius:20px;
  cursor:pointer;
  transition:all 0.3s;
  font-size:14px;
  flex:1;
  min-width:80px;
  text-align:center;
}

.filter-btn.active, .filter-btn:hover {
  background:var(--accent);
  color:white;
  border-color:var(--accent);
}

.sort-container {
  display:flex;
  gap:10px;
  margin:15px 0;
  flex-wrap:wrap;
}

.sort-btn {
  background:rgba(0,0,0,0.05);
  border:1px solid #ddd;
  padding:8px 15px;
  border-radius:20px;
  cursor:pointer;
  transition:all 0.3s;
  font-size:14px;
  flex:1;
  min-width:80px;
  text-align:center;
}

.sort-btn.active, .sort-btn:hover {
  background:var(--primary);
  color:white;
  border-color:var(--primary);
}

/* Category Badges */
.category-badge {
  display:inline-block;
  padding:3px 8px;
  border-radius:12px;
  font-size:12px;
  font-weight:bold;
  margin-top:5px;
  text-transform:uppercase;
}

.category-work { background:rgba(33,150,243,0.2); color:#1976d2; }
.category-study { background:rgba(156,39,176,0.2); color:#9c27b0; }
.category-health { background:rgba(76,175,80,0.2); color:#388e3c; }
.category-other { background:rgba(158,158,158,0.2); color:#616161; }

/* Smart Suggestion */
.suggestion-box {
  background:rgba(255,235,59,0.2);
  border-left:4px solid #ffc107;
  padding:12px;
  border-radius:8px;
  margin:15px 0;
  display:none;
}

.suggestion-box.active {
  display:block;
  animation:slideIn 0.3s ease;
}

.suggestion-btn {
  background:var(--warning);
  color:white;
  border:none;
  padding:5px 10px;
  border-radius:15px;
  font-size:14px;
  cursor:pointer;
  margin-top:8px;
  display:inline-block;
}

/* Snooze Modal */
.snooze-modal {
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  z-index:1000;
  justify-content:center;
  align-items:center;
}

.snooze-content {
  background:var(--card);
  border-radius:18px;
  padding:30px;
  max-width:400px;
  width:90%;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}

.snooze-options {
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:15px;
  margin:25px 0;
}

.snooze-btn-large {
  background:var(--primary);
  color:white;
  border:none;
  padding:15px;
  border-radius:12px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  transition:all 0.3s;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:5px;
}

.snooze-btn-large:hover {
  transform:scale(1.05);
  box-shadow:0 4px 15px rgba(0,0,0,.2);
}

.snooze-btn-large.cancel {
  background:#999;
}

/* Export/Import Buttons */
.export-import {
  display:flex;
  gap:10px;
  margin:20px 0;
  flex-wrap:wrap;
}

.export-import button {
  flex:1;
  min-width:120px;
  margin-top:0;
  padding:10px;
  font-size:14px;
}

/* Vibration Animation */
.vibrating {
  animation: vibrate 0.1s linear infinite;
}

@keyframes vibrate {
  0% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(0); }
  75% { transform: translateX(2px); }
  100% { transform: translateX(0); }
}

/* Notification Permission Banner */
.permission-banner {
  background:var(--warning);
  color:white;
  padding:15px;
  text-align:center;
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,.3);
  z-index:1000;
  max-width:90%;
  display:none;
}

.permission-banner.active {
  display:block;
  animation:slideIn 0.3s ease;
}

.permission-btn {
  background:white;
  color:var(--warning);
  border:none;
  padding:8px 15px;
  border-radius:20px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}

/* PWA Install Banner */
.install-banner {
  background:var(--primary);
  color:white;
  padding:15px;
  text-align:center;
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,.3);
  z-index:1000;
  max-width:90%;
  display:none;
}

.install-banner.active {
  display:block;
  animation:slideIn 0.3s ease;
}

.install-btn {
  background:white;
  color:var(--primary);
  border:none;
  padding:8px 15px;
  border-radius:20px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
@media (max-width:480px){
  .container{
    margin:10px;
    padding:15px;
    width:95%;
  }
  
  .topbar{
    padding:10px;
    font-size:18px;
    flex-direction:column;
    gap:10px;
    position:sticky;
    top:0;
    z-index:100;
  }
  
  .tab-container{
    width:100%;
    justify-content:space-around;
    padding:5px 0;
  }
  
  .tab-btn{
    min-width:80px;
    padding:6px 10px;
    font-size:14px;
  }
  
  button{
    padding:12px;
    font-size:15px;
  }
  
  .ringtones-grid{
    grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));
  }
  
  .ringtone-item{
    min-height:85px;
    padding:10px 5px;
    font-size:12px;
  }
  
  .ringtone-item i{
    font-size:22px;
  }
  
  .ringtone-item span{
    font-size:11px;
  }
  
  .timer-display, .stopwatch-display {
    font-size: 42px;
    letter-spacing: -1px;
  }
  
  .timer-inputs {
    flex-direction: row;
    justify-content: space-around;
    width:100%;
  }
  
  .timer-input-group {
    min-width:70px;
  }
  
  .timer-input-group input {
    width: 60px;
    font-size: 18px;
  }
  
  .timer-btn {
    padding: 12px 15px;
    min-width: 90px;
    font-size: 14px;
  }
  
  .stopwatch-controls .timer-btn {
    min-width: 85px;
    padding: 10px 15px;
    font-size: 14px;
  }
  
  .stats span {
    font-size:13px;
  }
  
  .page {
    min-height:auto;
    padding-top:70px;
    padding-bottom:20px;
  }
  
  .snooze-options {
    grid-template-columns:1fr;
  }
  
  .filter-container, .sort-container {
    flex-direction:column;
  }
  
  .filter-btn, .sort-btn {
    width:100%;
  }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
@media (min-width:768px){
  .container{
    margin:30px auto;
    max-width:500px;
  }
  
  .page {
    min-height:calc(100vh - 120px);
    padding-top:20px;
  }
}

/* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.content-wrapper {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding-top: 70px;
  box-sizing:border-box;
}

.main-content {
  flex:1;
  padding-bottom:30px;
}

/* Service Worker Status */
.sw-status {
  text-align:center;
  padding:10px;
  font-size:14px;
  margin-top:10px;
  border-radius:8px;
}

.sw-active {
  background:rgba(76, 175, 80, 0.15);
  color:#2e7d32;
  border:1px solid #4CAF50;
}

.sw-inactive {
  background:rgba(244, 67, 54, 0.15);
  color:#c62828;
  border:1px solid #f44336;
}
</style>
</head>

<body>
<div class="content-wrapper">
  <div class="topbar">
    <button class="toggle" id="modeBtn" onclick="toggleMode()">ğŸŒ™</button>
    <div class="tab-container">
      <button class="tab-btn active" id="tabAdd" onclick="switchTab('add')">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="tab-btn" id="tabList" onclick="switchTab('list')">ğŸ“‹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
      <button class="tab-btn" id="tabTimer" onclick="switchTab('timer')">â± Ù…Ù†Ø¨Ù‡ Ø³Ø±ÙŠØ¹</button>
      <button class="tab-btn" id="tabStopwatch" onclick="switchTab('stopwatch')">â±ï¸ Ø³Ø§Ø¹Ø© Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
    <div style="width:38px;"></div>
  </div>

  <div class="main-content">
    <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
    <div class="page active" id="pageAdd">
      <div class="container">
        <div id="messageContainer"></div>
        
        <div class="suggestion-box" id="suggestionBox">
          <strong>ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ø°ÙƒÙŠ:</strong>
          <p>ØªÙ… Ø§ÙƒØªØ´Ø§Ù "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±" - Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŸ</p>
          <button class="suggestion-btn" onclick="applyPrayerTime()">Ù†Ø¹Ù…ØŒ Ø¹ÙŠÙ‘Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± (3:30 Ø¹ØµØ±Ù‹Ø§)</button>
        </div>

        <div class="field">
          <label>ğŸ“Œ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
          <input id="title" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¹Ø¯" maxlength="100" oninput="checkSmartSuggestions(this.value)" autofocus>
        </div>

        <div class="field">
          <label>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="date" min="">
        </div>

        <div class="field">
          <label>â° Ø§Ù„ÙˆÙ‚Øª</label>
          <input type="time" id="time" min="">
        </div>

        <div class="field">
          <label>ğŸ“‚ Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="category">
            <option value="other">Ø£Ø®Ø±Ù‰</option>
            <option value="work">ğŸ’¼ Ø¹Ù…Ù„</option>
            <option value="study">ğŸ“š Ø¯Ø±Ø§Ø³Ø©</option>
            <option value="health">ğŸ’ª ØµØ­Ø©</option>
          </select>
        </div>

        <div class="field">
          <label>ğŸ” Ø§Ù„ØªÙƒØ±Ø§Ø±</label>
          <select id="repeat">
            <option value="none">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
            <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="daily-except-friday">ÙŠÙˆÙ…ÙŠ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
            <option value="monthly-10th">ÙƒÙ„ Ø´Ù‡Ø± ÙŠÙˆÙ… 10</option>
          </select>
        </div>

        <div class="field">
          <label>ğŸµ Ø§Ø®ØªØ± Ù†ØºÙ…Ø© Ø§Ù„Ù…Ù†Ø¨Ù‡</label>
          <div class="ringtones-grid" id="ringtonesGrid">
            <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
          </div>
          
          <div class="or-divider"></div>
          
          <button onclick="document.getElementById('sound').click()" style="background:#9c27b0;margin-top:0;">
            ğŸ“± Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…Ù„ÙØ§Øª Ø¬Ù‡Ø§Ø²ÙŠ
          </button>
          <input type="file" id="sound" accept="audio/*" style="display:none;" onchange="handleFileSelect(this)">
        </div>

        <div class="record-section">
          <h4>ğŸ™ Ø£Ùˆ Ø³Ø¬Ù„ ØªØ°ÙƒÙŠØ±Ùƒ Ø§Ù„ØµÙˆØªÙŠ</h4>
          <button class="record" id="recordBtn" onclick="toggleRecord(this)">ğŸ™ Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</button>
        </div>

        <div class="field">
          <label>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="note" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3"></textarea>
        </div>

        <button class="main-btn" id="addUpdateBtn" onclick="addOrUpdateReminder()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
    <div class="page" id="pageList">
      <div class="container">
        <div class="search-container">
          <i>ğŸ”</i>
          <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¹Ø¯..." onkeyup="filterReminders()">
        </div>
        
        <div class="filter-container">
          <button class="filter-btn active" onclick="setFilter('all')">Ø§Ù„ÙƒÙ„</button>
          <button class="filter-btn" onclick="setFilter('pending')">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</button>
          <button class="filter-btn" onclick="setFilter('completed')">Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</button>
          <button class="filter-btn" onclick="setFilter('today')">Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        
        <div class="sort-container">
          <button class="sort-btn active" onclick="setSort('time')">â° Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</button>
          <button class="sort-btn" onclick="setSort('title')">Ø£Ø¨Ø¬Ø¯ÙŠ</button>
          <button class="sort-btn" onclick="setSort('category')">ğŸ“‚ Ø§Ù„ØªØµÙ†ÙŠÙ</button>
        </div>
        
        <div class="export-import">
          <button style="background:#2196F3;" onclick="exportReminders()">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
          <button style="background:#9c27b0;" onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importReminders(this)">
        </div>
        
        <div class="stats" id="stats">
          <span>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: <strong id="totalReminders">0</strong></span>
          <span>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: <strong id="completedReminders">0</strong></span>
          <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <strong id="pendingReminders">0</strong></span>
        </div>

        <div id="list"></div>
        
        <div class="sw-status" id="swStatus">
          <span>âš™ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</span>
        </div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="page" id="pageTimer">
      <div class="container">
        <h2 style="text-align:center; margin-bottom:10px; font-size:24px;">â± Ù…Ù†Ø¨Ù‡ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ</h2>
        <p style="text-align:center; color:#666; margin-bottom:25px; font-size:15px;">Ø§Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ù„ØªÙ†Ø¨ÙŠÙ‡Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
        
        <div class="timer-inputs">
          <div class="timer-input-group">
            <input type="number" id="timerHours" min="0" max="23" value="0" placeholder="Ø³Ø§Ø¹Ø©">
            <label>Ø³Ø§Ø¹Ø©</label>
          </div>
          <div class="timer-input-group">
            <input type="number" id="timerMinutes" min="0" max="59" value="1" placeholder="Ø¯Ù‚ÙŠÙ‚Ø©">
            <label>Ø¯Ù‚ÙŠÙ‚Ø©</label>
          </div>
          <div class="timer-input-group">
            <input type="number" id="timerSeconds" min="0" max="59" value="0" placeholder="Ø«Ø§Ù†ÙŠØ©">
            <label>Ø«Ø§Ù†ÙŠØ©</label>
          </div>
        </div>
        
        <div class="timer-display" id="timerDisplay">00:01:00</div>
        
        <div class="timer-controls">
          <button class="timer-btn start" id="timerStartBtn" onclick="startTimer()">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
          <button class="timer-btn pause" id="timerPauseBtn" onclick="pauseTimer()" disabled>â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
          <button class="timer-btn reset" id="timerResetBtn" onclick="resetTimer()">â¹ï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
        
        <div style="margin-top:25px; padding:15px; background:rgba(76,175,80,0.1); border-radius:12px; text-align:center;">
          <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ ØµÙˆØª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        </div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù -->
    <div class="page" id="pageStopwatch">
      <div class="container">
        <h2 style="text-align:center; margin-bottom:10px; font-size:24px;">â±ï¸ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù</h2>
        <p style="text-align:center; color:#666; margin-bottom:25px; font-size:15px;">Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ø£Ùˆ Ø¶Ø¨Ø· Ù…Ù†Ø¨Ù‡ Ø¨Ø¹Ø¯ Ù…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©</p>
        
        <div class="stopwatch-display" id="stopwatchDisplay">00:00:00.00</div>
        
        <div class="timer-controls">
          <button class="timer-btn start" id="stopwatchStartBtn" onclick="startStopwatch()">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
          <button class="timer-btn pause" id="stopwatchPauseBtn" onclick="pauseStopwatch()" disabled>â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
          <button class="timer-btn reset" id="stopwatchResetBtn" onclick="resetStopwatch()">â¹ï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button class="timer-btn" style="background:#9c27b0;" id="stopwatchLapBtn" onclick="lapStopwatch()" disabled>ğŸ“Œ Ù„ÙÙ‘Ø©</button>
        </div>
        
        <div class="timer-controls" style="margin-top:10px;">
          <button class="timer-btn" style="background:#2196F3; min-width:180px;" onclick="setTimerFromStopwatch()">
            ğŸ¯ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ…Ù†Ø¨Ù‡
          </button>
        </div>
        
        <div class="laps-container" id="lapsContainer">
          <!-- Ù„ÙØ§Øª Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
        
        <div style="margin-top:25px; padding:15px; background:rgba(33,150,243,0.1); border-radius:12px; text-align:center;">
          <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ…Ù†Ø¨Ù‡"
        </div>
      </div>
    </div>
  </div>
  
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØºÙÙˆØ© -->
  <div class="snooze-modal" id="snoozeModal">
    <div class="snooze-content">
      <h2 style="margin-top:0;">â° ØºÙÙˆØ© Ø§Ù„Ù…Ù†Ø¨Ù‡</h2>
      <p id="snoozeReminderTitle" style="font-weight:bold; margin-bottom:20px;"></p>
      <div class="snooze-options">
        <button class="snooze-btn-large" onclick="snoozeReminder(5)">
          <span>5 Ø¯Ù‚Ø§Ø¦Ù‚</span>
          <span>â˜•</span>
        </button>
        <button class="snooze-btn-large" onclick="snoozeReminder(10)">
          <span>10 Ø¯Ù‚Ø§Ø¦Ù‚</span>
          <span>ğŸ˜´</span>
        </button>
        <button class="snooze-btn-large" onclick="snoozeReminder(15)">
          <span>15 Ø¯Ù‚ÙŠÙ‚Ø©</span>
          <span>ğŸ’¤</span>
        </button>
        <button class="snooze-btn-large cancel" onclick="closeSnoozeModal()">
          <span>Ø¥Ù„ØºØ§Ø¡</span>
          <span>âŒ</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Ø¨Ù†Ø± Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div class="permission-banner" id="permissionBanner">
    <strong>ğŸ”” Ù†Ø±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ùƒ!</strong>
    <p>Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
    <button class="permission-btn" onclick="requestNotificationPermission()">Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
  </div>
  
  <!-- Ø¨Ù†Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div class="install-banner" id="installBanner">
    <strong>ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!</strong>
    <p>Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©ØŒ Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</p>
    <button class="install-btn" onclick="installApp()">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
  </div>
</div>

<script>
// ============================================
// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
// ============================================
let reminders = [];
let mode = localStorage.getItem("mode");
let recorder, chunks = [], recordedAudio = null, recording = false;
let selectedRingtone = null;
let isTabActive = true;
let isCheckingMissed = false;
let previewAudio = null;
let timerInterval = null;
let timerRemaining = 60000; // Default 1 minute in milliseconds
let isTimerRunning = false;
let stopwatchInterval = null;
let stopwatchStartTime = 0;
let stopwatchElapsedTime = 0;
let isStopwatchRunning = false;
let laps = [];
let audioContext = null;
let db = null; // IndexedDB database
let currentFilter = 'all';
let currentSort = 'time';
let editingReminderId = null;
let snoozingReminder = null;
let speechSynthesis = null;
let swRegistration = null;
let deferredPrompt = null;
let notificationPermissionRequested = localStorage.getItem('notificationPermissionRequested') === 'true';

const modeBtn = document.getElementById("modeBtn");
const titleInput = document.getElementById("title");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const noteInput = document.getElementById("note");
const soundInput = document.getElementById("sound");
const repeatSelect = document.getElementById("repeat");
const categorySelect = document.getElementById("category");
const recordBtn = document.getElementById("recordBtn");
const messageContainer = document.getElementById("messageContainer");
const ringtonesGrid = document.getElementById("ringtonesGrid");
const list = document.getElementById("list");
const timerDisplay = document.getElementById("timerDisplay");
const timerStartBtn = document.getElementById("timerStartBtn");
const timerPauseBtn = document.getElementById("timerPauseBtn");
const timerResetBtn = document.getElementById("timerResetBtn");
const timerHours = document.getElementById("timerHours");
const timerMinutes = document.getElementById("timerMinutes");
const timerSeconds = document.getElementById("timerSeconds");
const stopwatchDisplay = document.getElementById("stopwatchDisplay");
const stopwatchStartBtn = document.getElementById("stopwatchStartBtn");
const stopwatchPauseBtn = document.getElementById("stopwatchPauseBtn");
const stopwatchResetBtn = document.getElementById("stopwatchResetBtn");
const stopwatchLapBtn = document.getElementById("stopwatchLapBtn");
const lapsContainer = document.getElementById("lapsContainer");
const searchInput = document.getElementById("searchInput");
const addUpdateBtn = document.getElementById("addUpdateBtn");
const snoozeModal = document.getElementById("snoozeModal");
const snoozeReminderTitle = document.getElementById("snoozeReminderTitle");
const suggestionBox = document.getElementById("suggestionBox");
const permissionBanner = document.getElementById("permissionBanner");
const installBanner = document.getElementById("installBanner");
const swStatus = document.getElementById("swStatus");

// ============================================
// Ø§Ù„Ù†ØºÙ…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…ÙˆÙ„Ø¯ ØµÙˆØª Ù…Ø¯Ù…Ø¬)
// ============================================
const defaultRingtones = [
  { name: "Ø¬Ø±Ø³ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ", icon: "ğŸ””", type: "beep", freq: 800, duration: 0.3 },
  { name: "ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø·ÙŠÙ", icon: "ğŸµ", type: "beep", freq: 600, duration: 0.5 },
  { name: "Ù†Ù‚Ø±Ø§Øª Ù…Ø§Ø¦ÙŠØ©", icon: "ğŸ’§", type: "double-beep", freq: 700, duration: 0.2 },
  { name: "Ø¬Ø±Ø³ Ø¨Ø§Ø¨", icon: "ğŸšª", type: "triple-beep", freq: 500, duration: 0.15 },
  { name: "Ø¥Ø´Ø¹Ø§Ø¹ Ù†Ø§Ø¹Ù…", icon: "âœ¨", type: "sweep", startFreq: 400, endFreq: 800, duration: 0.4 },
  { name: "Ù†Ù‚Ø±Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©", icon: "ğŸ”˜", type: "click", freq: 900, duration: 0.1 },
  { name: "ØªÙ†Ø¨ÙŠÙ‡ Ù‚ØµÙŠØ±", icon: "ğŸ”Š", type: "beep", freq: 1000, duration: 0.2 },
  { name: "Ù†ØºÙ…Ø© Ù‡Ø§ØªÙ", icon: "ğŸ“±", type: "ring", freq: 650, duration: 1.0 }
];

// ============================================
// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB
// ============================================
function initDatabase() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("ReminderDB", 5);
    
    request.onupgradeneeded = function(event) {
      db = event.target.result;
      
      if (!db.objectStoreNames.contains("reminders")) {
        const store = db.createObjectStore("reminders", { keyPath: "id" });
        store.createIndex("time", "time", { unique: false });
      }
      
      if (!db.objectStoreNames.contains("audio")) {
        const audioStore = db.createObjectStore("audio", { keyPath: "id" });
        audioStore.createIndex("reminderId", "reminderId", { unique: false });
      }
      
      if (!db.objectStoreNames.contains("scheduled")) {
        const scheduledStore = db.createObjectStore("scheduled", { keyPath: "id" });
        scheduledStore.createIndex("triggerTime", "triggerTime", { unique: false });
      }
    };
    
    request.onsuccess = function(event) {
      db = event.target.result;
      console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
      resolve(db);
    };
    
    request.onerror = function(event) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", event.target.error);
      reject(event.target.error);
    };
  });
}

// ============================================
// Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙÙŠ IndexedDB
// ============================================
async function saveReminderToDB(reminder) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©");
      return;
    }
    
    const transaction = db.transaction(["reminders"], "readwrite");
    const store = transaction.objectStore("reminders");
    
    if (reminder.sound && typeof reminder.sound === 'string' && reminder.sound.startsWith('')) {
      const audioId = `audio_${reminder.id}`;
      
      const audioTransaction = db.transaction(["audio"], "readwrite");
      const audioStore = audioTransaction.objectStore("audio");
      
      audioStore.put({
        id: audioId,
        reminderId: reminder.id,
        data: reminder.sound
      });
      
      reminder.sound = audioId;
    }
    
    const request = store.put(reminder);
    
    request.onsuccess = () => {
      console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
      resolve();
    };
    
    request.onerror = (event) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯:", event.target.error);
      reject(event.target.error);
    };
  });
}

// ============================================
// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ù† IndexedDB
// ============================================
async function loadRemindersFromDB() {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©");
      return;
    }
    
    const transaction = db.transaction(["reminders"], "readonly");
    const store = transaction.objectStore("reminders");
    const request = store.openCursor();
    const reminders = [];
    
    request.onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor) {
        reminders.push(cursor.value);
        cursor.continue();
      } else {
        Promise.all(reminders.map(async (reminder) => {
          if (typeof reminder.sound === 'string' && reminder.sound.startsWith('audio_')) {
            try {
              const audioData = await loadAudioFromDB(reminder.sound);
              reminder.sound = audioData;
            } catch (e) {
              console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
              reminder.sound = { type: "beep", freq: 800, duration: 0.3 };
            }
          }
          return reminder;
        })).then(() => {
          resolve(reminders);
        }).catch(reject);
      }
    };
    
    request.onerror = (event) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:", event.target.error);
      reject(event.target.error);
    };
  });
}

// ============================================
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† IndexedDB
// ============================================
function loadAudioFromDB(audioId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©");
      return;
    }
    
    const transaction = db.transaction(["audio"], "readonly");
    const store = transaction.objectStore("audio");
    const request = store.get(audioId);
    
    request.onsuccess = (event) => {
      const result = event.target.result;
      if (result) {
        resolve(result.data);
      } else {
        reject("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª");
      }
    };
    
    request.onerror = (event) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª:", event.target.error);
      reject(event.target.error);
    };
  });
}

// ============================================
// Ø­Ø°Ù Ù…ÙˆØ¹Ø¯ Ù…Ù† IndexedDB
// ============================================
async function deleteReminderFromDB(id) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©");
      return;
    }
    
    const transaction = db.transaction(["reminders"], "readwrite");
    const store = transaction.objectStore("reminders");
    const deleteRequest = store.delete(id);
    
    deleteRequest.onsuccess = () => {
      const audioId = `audio_${id}`;
      const audioTransaction = db.transaction(["audio"], "readwrite");
      const audioStore = audioTransaction.objectStore("audio");
      audioStore.delete(audioId);
      
      console.log("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙˆØ§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø¬Ø§Ø­");
      resolve();
    };
    
    deleteRequest.onerror = (event) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯:", event.target.error);
      reject(event.target.error);
    };
  });
}

// ============================================
// Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
// ============================================
async function scheduleBackgroundNotification(reminder) {
  if (!swRegistration) {
    console.log("Service Worker ØºÙŠØ± Ù…ØªÙˆÙØ±");
    return;
  }
  
  try {
    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
    const scheduled = {
      id: `scheduled_${reminder.id}`,
      reminderId: reminder.id,
      title: reminder.title,
      body: reminder.note || `Ù…ÙˆØ¹Ø¯: ${reminder.title}`,
      triggerTime: new Date(reminder.time).getTime(),
      repeat: reminder.repeat,
      sound: reminder.sound,
      category: reminder.category
    };
    
    const transaction = db.transaction(["scheduled"], "readwrite");
    const store = transaction.objectStore("scheduled");
    store.put(scheduled);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Service Worker Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    if (swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'SCHEDULE_NOTIFICATION',
        data: scheduled
      });
      
      console.log("ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©:", scheduled);
    }
  } catch (e) {
    console.error("ÙØ´Ù„ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©:", e);
  }
}

// ============================================
// Ø¥Ù„ØºØ§Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø´Ø¹Ø§Ø±
// ============================================
async function cancelScheduledNotification(reminderId) {
  if (!swRegistration) return;
  
  try {
    const scheduledId = `scheduled_${reminderId}`;
    
    // Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const transaction = db.transaction(["scheduled"], "readwrite");
    const store = transaction.objectStore("scheduled");
    store.delete(scheduledId);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Service Worker Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    if (swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'CANCEL_NOTIFICATION',
        id: scheduledId
      });
    }
  } catch (e) {
    console.error("ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", e);
  }
}

// ============================================
// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ø³Ù‘Ù†
// ============================================
function showAppNotification(title, options) {
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ØµÙØ­Ø©
  if (Notification.permission === 'granted') {
    try {
      const notification = new Notification(title, options);
      
      // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      notification.onclick = function(event) {
        event.preventDefault();
        window.focus();
        this.close();
      };
    } catch (e) {
      console.error("ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ØµÙØ­Ø©:", e);
    }
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Service Worker Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  if (swRegistration && swRegistration.active) {
    swRegistration.active.postMessage({
      type: 'SHOW_NOTIFICATION',
      title: title,
      options: options
    });
  }
}

// ============================================
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
// ============================================
if(mode === "dark"){
  document.body.classList.add("dark");
  modeBtn.textContent = "â˜€";
}

// ============================================
// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
// ============================================
function formatLocalDateTime(date) {
  return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 16);
}

// ============================================
// Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
// ============================================
function formatDateArabic(date) {
  const options = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  return date.toLocaleDateString('ar-EG', options);
}

// ============================================
// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
// ============================================
function showMessage(text, type = 'success') {
  if (previewAudio) {
    if (previewAudio.stop) previewAudio.stop();
    previewAudio = null;
  }
  
  const alertClass = {
    'success': 'alert-success',
    'warning': 'alert-warning',
    'error': 'alert-error'
  };
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `alert ${alertClass[type]}`;
  messageDiv.innerHTML = text;
  
  messageContainer.innerHTML = '';
  messageContainer.appendChild(messageDiv);
  
  setTimeout(() => {
    messageContainer.innerHTML = '';
  }, 5000);
}

// ============================================
// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
// ============================================
function toggleMode() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  modeBtn.textContent = isDark ? "â˜€" : "ğŸŒ™";
  localStorage.setItem("mode", isDark ? "dark" : "light");
}

// ============================================
// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
// ============================================
function switchTab(tab) {
  if (previewAudio) {
    if (previewAudio.stop) previewAudio.stop();
    previewAudio = null;
  }
  
  if (isTimerRunning && tab !== 'timer') {
    pauseTimer();
  }
  
  if (isStopwatchRunning && tab !== 'stopwatch') {
    pauseStopwatch();
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  if (tab === 'add') {
    document.getElementById('pageAdd').classList.add('active');
    document.getElementById('tabAdd').classList.add('active');
    resetForm();
  } else if (tab === 'list') {
    document.getElementById('pageList').classList.add('active');
    document.getElementById('tabList').classList.add('active');
    show();
  } else if (tab === 'timer') {
    document.getElementById('pageTimer').classList.add('active');
    document.getElementById('tabTimer').classList.add('active');
    updateTimerDisplay();
  } else if (tab === 'stopwatch') {
    document.getElementById('pageStopwatch').classList.add('active');
    document.getElementById('tabStopwatch').classList.add('active');
    updateStopwatchDisplay();
  }
}

// ============================================
// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
// ============================================
function resetForm() {
  titleInput.value = "";
  noteInput.value = "";
  soundInput.value = "";
  recordedAudio = null;
  selectedRingtone = null;
  recordBtn.innerText = "ğŸ™ Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)";
  recordBtn.classList.remove('recording');
  editingReminderId = null;
  addUpdateBtn.textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯";
  addUpdateBtn.className = "main-btn";
  categorySelect.value = "other";
  
  document.querySelectorAll('.ringtone-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  const nowDate = new Date();
  nowDate.setMinutes(nowDate.getMinutes() + 1);
  const year = nowDate.getFullYear();
  const month = String(nowDate.getMonth() + 1).padStart(2, '0');
  const day = String(nowDate.getDate()).padStart(2, '0');
  const hours = String(nowDate.getHours()).padStart(2, '0');
  const minutes = String(nowDate.getMinutes()).padStart(2, '0');
  
  dateInput.value = `${year}-${month}-${day}`;
  timeInput.value = `${hours}:${minutes}`;
  updateMinTime();
  suggestionBox.classList.remove('active');
}

// ============================================
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©
// ============================================
function checkSmartSuggestions(title) {
  const lowerTitle = title.toLowerCase();
  if (lowerTitle.includes("ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±") || lowerTitle.includes("ØµÙ„Ø§Ø© Ø¹ØµØ±") || lowerTitle.includes("Ø§Ù„Ø¹ØµØ±")) {
    suggestionBox.classList.add('active');
  } else {
    suggestionBox.classList.remove('active');
  }
}

// ============================================
// ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±
// ============================================
function applyPrayerTime() {
  const now = new Date();
  const today = new Date();
  today.setHours(15, 30, 0, 0); // 3:30 PM
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ 3:30ØŒ Ø¹ÙŠÙ‘Ù† Ù„ÙŠÙˆÙ… ØºØ¯
  if (now > today) {
    today.setDate(today.getDate() + 1);
  }
  
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const hours = String(today.getHours()).padStart(2, '0');
  const minutes = String(today.getMinutes()).padStart(2, '0');
  
  dateInput.value = `${year}-${month}-${day}`;
  timeInput.value = `${hours}:${minutes}`;
  suggestionBox.classList.remove('active');
  showMessage("âœ“ ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§", 'success');
}

// ============================================
// Ø¯Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù
// ============================================
function readFile(file) {
  return new Promise((resolve, reject) => {
    if (!file) {
      resolve(null);
      return;
    }
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ============================================
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
// ============================================
function handleFileSelect(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    if (file.size > 2 * 1024 * 1024) { // 2MB
      showMessage("âš ï¸ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB)", 'error');
      input.value = '';
      return;
    }
    
    readFile(file).then(data => {
      selectedRingtone = data;
      document.querySelectorAll('.ringtone-item').forEach(item => {
        item.classList.remove('selected');
      });
      showMessage(`âœ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}`, 'success');
    }).catch(e => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:", e);
      showMessage("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØª", 'error');
    });
  }
}

// ============================================
// ØªØ´ØºÙŠÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†ØºÙ…Ø©
// ============================================
function playPreview(soundConfig, element) {
  if (previewAudio) {
    if (previewAudio.stop) previewAudio.stop();
    previewAudio = null;
  }
  
  try {
    if (typeof soundConfig === 'string' && soundConfig.startsWith('')) {
      previewAudio = new Audio(soundConfig);
      previewAudio.volume = 0.7;
      previewAudio.play();
      
      const btn = element.querySelector('.preview-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â¸ï¸';
      
      previewAudio.onended = () => {
        btn.innerHTML = originalText;
        previewAudio = null;
      };
      
      previewAudio.onerror = () => {
        btn.innerHTML = originalText;
        previewAudio = null;
        console.error("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø©");
        showMessage("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø©. Ø¬Ø±Ø¨ Ù†ØºÙ…Ø© Ø£Ø®Ø±Ù‰.", 'error');
        playFallbackSound();
      };
    } else {
      previewAudio = playSound(soundConfig, 0.3);
      
      const btn = element.querySelector('.preview-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â¸ï¸';
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        if (previewAudio && previewAudio.stop) previewAudio.stop();
        previewAudio = null;
      }, (soundConfig.duration || 0.3) * 1000 + 200);
    }
  } catch (e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:", e);
    showMessage("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø©", 'error');
    playFallbackSound();
  }
}

// ============================================
// Ø§Ø®ØªÙŠØ§Ø± Ù†ØºÙ…Ø© Ù…Ù† Ø§Ù„Ù†ØºÙ…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
// ============================================
function selectRingtone(element, soundConfig) {
  if (previewAudio) {
    if (previewAudio.stop) previewAudio.stop();
    previewAudio = null;
  }
  
  document.querySelectorAll('.ringtone-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  element.classList.add('selected');
  selectedRingtone = soundConfig;
  
  showMessage("âœ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ØºÙ…Ø©: " + element.querySelector('span').textContent, 'success');
}

// ============================================
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
// ============================================
function loadDefaultRingtones() {
  ringtonesGrid.innerHTML = '';
  
  defaultRingtones.forEach((ringtone, index) => {
    const item = document.createElement('div');
    item.className = 'ringtone-item';
    item.innerHTML = `
      <i>${ringtone.icon}</i>
      <span>${ringtone.name}</span>
      <button class="preview-btn">â–¶ï¸ Ø§Ø³ØªÙ…Ø§Ø¹</button>
    `;
    
    item.querySelector('.preview-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      playPreview(ringtone, item);
    });
    
    item.addEventListener('click', () => selectRingtone(item, ringtone));
    
    ringtonesGrid.appendChild(item);
  });
}

// ============================================
// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
// ============================================
async function toggleRecord(btn) {
  try {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
      showMessage("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª", 'error');
      return;
    }

    if (!recording) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
      recorder.start();
      chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recording = true;
      btn.innerText = "â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...)";
      btn.classList.add('recording');
      showMessage("ğŸ¤ ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„... (10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)", 'success');
      
      setTimeout(() => {
        if (recording) {
          recorder.stop();
          handleRecordingStop();
        }
      }, 10000);
    } else {
      recorder.stop();
      handleRecordingStop();
    }
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err);
    showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + (err.name === 'NotAllowedError' ? "ÙŠØ±Ø¬Ù‰ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†" : err.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"), 'error');
    recording = false;
    recordBtn.innerText = "ğŸ™ Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)";
    recordBtn.classList.remove('recording');
    if (recorder && recorder.stream) {
      recorder.stream.getTracks().forEach(track => track.stop());
    }
  }
}

function handleRecordingStop() {
  recorder.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/webm;codecs=opus" });
    
    if (blob.size > 500 * 1024) { // 500 KB
      showMessage("âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500KB). Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.", 'warning');
      recordedAudio = null;
      selectedRingtone = null;
    } else {
      const reader = new FileReader();
      reader.onload = () => {
        recordedAudio = reader.result;
        selectedRingtone = null;
        document.querySelectorAll('.ringtone-item').forEach(item => {
          item.classList.remove('selected');
        });
        showMessage("âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", 'success');
      };
      reader.readAsDataURL(blob);
    }
    
    recorder.stream.getTracks().forEach(track => track.stop());
  };
  
  recording = false;
  recordBtn.innerText = "ğŸ™ Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)";
  recordBtn.classList.remove('recording');
}

// ============================================
// Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« ØªØ°ÙƒÙŠØ±
// ============================================
async function addOrUpdateReminder() {
  if (!titleInput.value.trim()) {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¹Ø¯", 'error');
    titleInput.focus();
    return;
  }

  if (!dateInput.value) {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®", 'error');
    dateInput.focus();
    return;
  }

  if (!timeInput.value) {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª", 'error');
    timeInput.focus();
    return;
  }

  const now = new Date();
  const selectedDateTime = new Date(dateInput.value + "T" + timeInput.value);
  
  if (selectedDateTime <= now) {
    showMessage("âš ï¸ Ø§Ù„ÙˆÙ‚Øª ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ø­ØªÙ‰ Ù„Ùˆ Ø¨Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©)!", 'error');
    return;
  }

  let audioData = null;
  
  if (recordedAudio) {
    audioData = recordedAudio;
  } else if (selectedRingtone) {
    audioData = selectedRingtone;
  } else {
    audioData = defaultRingtones[0];
  }

  const category = categorySelect.value || 'other';

  if (editingReminderId) {
    const index = reminders.findIndex(r => r.id === editingReminderId);
    if (index !== -1) {
      // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      await cancelScheduledNotification(editingReminderId);
      
      reminders[index] = {
        id: editingReminderId,
        title: titleInput.value.trim(),
        time: dateInput.value + "T" + timeInput.value,
        note: noteInput.value.trim(),
        sound: audioData,
        repeat: repeatSelect.value,
        category: category,
        done: false
      };
      
      try {
        await saveReminderToDB(reminders[index]);
        // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        await scheduleBackgroundNotification(reminders[index]);
        showMessage("âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
      } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", e);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", 'error');
        return;
      }
    }
  } else {
    const newReminder = {
      title: titleInput.value.trim(),
      time: dateInput.value + "T" + timeInput.value,
      note: noteInput.value.trim(),
      sound: audioData,
      repeat: repeatSelect.value,
      category: category,
      done: false,
      id: Date.now()
    };

    try {
      await saveReminderToDB(newReminder);
      reminders.push(newReminder);
      
      // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
      await scheduleBackgroundNotification(newReminder);
      
      showMessage("âœ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:", e);
      showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", 'error');
      return;
    }
  }

  if (audioData) {
    try {
      initAudioContext();
      playSound(audioData, 0.5);
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
      playFallbackSound();
    }
  }

  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± ØªØ£ÙƒÙŠØ¯
  showAppNotification("ğŸ“Œ ØªØ°ÙƒÙŠØ± " + (editingReminderId ? "Ù…Ø­Ø¯Ù‘Ø«" : "Ø¬Ø¯ÙŠØ¯"), {
    body: `${titleInput.value} ÙÙŠ ${timeInput.value}`,
    icon: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
    badge: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
    requireInteraction: false,
    silent: true
  });

  resetForm();
  
  if (document.getElementById('pageList').classList.contains('active')) {
    show();
  }
}

// ============================================
// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ°ÙƒÙŠØ±
// ============================================
function updateMinTime() {
  const now = new Date();
  const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  
  if (dateInput.value === todayStr) {
    const currentHours = now.getHours().toString().padStart(2, '0');
    const currentMinutes = now.getMinutes().toString().padStart(2, '0');
    timeInput.min = `${currentHours}:${currentMinutes}`;
  } else {
    timeInput.min = "00:00";
  }
}

// ============================================
// Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
// ============================================
async function show() {
  const now = new Date();
  let total = 0, completed = 0, pending = 0;
  let html = '';
  
  let filteredReminders = [...reminders];
  
  if (currentFilter === 'pending') {
    filteredReminders = filteredReminders.filter(r => !r.done && new Date(r.time) > now);
  } else if (currentFilter === 'completed') {
    filteredReminders = filteredReminders.filter(r => r.done || new Date(r.time) <= now);
  } else if (currentFilter === 'today') {
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    filteredReminders = filteredReminders.filter(r => {
      const reminderTime = new Date(r.time);
      return reminderTime >= todayStart && reminderTime < todayEnd;
    });
  }
  
  const searchTerm = searchInput.value.toLowerCase().trim();
  if (searchTerm) {
    filteredReminders = filteredReminders.filter(r => 
      r.title.toLowerCase().includes(searchTerm) || 
      (r.note && r.note.toLowerCase().includes(searchTerm)) ||
      (r.category && r.category.includes(searchTerm))
    );
  }

  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  dateInput.min = `${year}-${month}-${day}`;
  
  if (!dateInput.value || dateInput.value < `${year}-${month}-${day}`) {
    dateInput.value = `${year}-${month}-${day}`;
  }
  
  updateMinTime();

  // Ø§Ù„ØªØ±ØªÙŠØ¨
  if (currentSort === 'time') {
    filteredReminders.sort((a, b) => new Date(a.time) - new Date(b.time));
  } else if (currentSort === 'title') {
    filteredReminders.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
  } else if (currentSort === 'category') {
    filteredReminders.sort((a, b) => (a.category || 'other').localeCompare(b.category || 'other'));
  }

  for (const r of filteredReminders) {
    total++;
    const target = new Date(r.time);
    const isDone = r.done || now > target;
    
    if (isDone) completed++;
    else pending++;

    if (isTabActive && !r.done && now >= target) {
      r.done = true;
      
      if (r.sound) {
        try {
          initAudioContext();
          playSound(r.sound, 0.8);
          
          // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¥Ø°Ø§ Ù…Ø¯Ø¹ÙˆÙ…
          if (navigator.vibrate) {
            navigator.vibrate([500, 200, 500]);
          }
          
          // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…
          speakReminder(r.title);
        } catch (e) {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…Ù†Ø¨Ù‡:", e);
          playFallbackSound();
        }
      } else {
        playFallbackSound();
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      showAppNotification("â° " + r.title, {
        body: "Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ø¢Ù†! " + (r.note ? "\n" + r.note : ""),
        icon: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
        badge: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
        requireInteraction: true,
        silent: false
      });

      snoozingReminder = r;
      snoozeReminderTitle.textContent = r.title;
      snoozeModal.style.display = 'flex';

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ
      if (r.repeat !== "none") {
        const next = new Date(target);
        
        if (r.repeat === "daily") {
          next.setDate(next.getDate() + 1);
        } else if (r.repeat === "weekly") {
          next.setDate(next.getDate() + 7);
        } else if (r.repeat === "daily-except-friday") {
          next.setDate(next.getDate() + 1);
          // ØªØ®Ø·ÙŠ Ø§Ù„Ø¬Ù…Ø¹Ø© (5 Ù‡Ùˆ Ø§Ù„Ø¬Ù…Ø¹Ø©)
          if (next.getDay() === 5) {
            next.setDate(next.getDate() + 1);
          }
        } else if (r.repeat === "monthly-10th") {
          next.setMonth(next.getMonth() + 1);
          next.setDate(10);
        }
        
        r.time = formatLocalDateTime(next);
        r.done = false;
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±
        await scheduleBackgroundNotification(r);
      } else {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        await cancelScheduledNotification(r.id);
      }
      
      try {
        await saveReminderToDB(r);
      } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯:", e);
      }
    }

    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
    let timeStatus = 'upcoming';
    const timeDiff = target - now;
    
    if (timeDiff < 0 && !r.done) {
      timeStatus = 'overdue';
    } else if (timeDiff < 60 * 60 * 1000) { // Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©
      timeStatus = 'soon';
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØµÙ†ÙŠÙ
    const categoryIcons = {
      'work': 'ğŸ’¼',
      'study': 'ğŸ“š',
      'health': 'ğŸ’ª',
      'other': 'ğŸ“Œ'
    };
    
    const categoryNames = {
      'work': 'Ø¹Ù…Ù„',
      'study': 'Ø¯Ø±Ø§Ø³Ø©',
      'health': 'ØµØ­Ø©',
      'other': 'Ø£Ø®Ø±Ù‰'
    };

    html += `
      <div class="item ${r.done ? 'done' : timeStatus}">
        <div style="flex:1; min-width:0;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
            <span style="font-size:18px;">${categoryIcons[r.category] || 'ğŸ“Œ'}</span>
            <b>${r.title}</b>
            <span class="category-badge category-${r.category || 'other'}">${categoryNames[r.category] || 'Ø£Ø®Ø±Ù‰'}</span>
          </div>
          <span class="time-display">â° ${formatDateArabic(target)}</span><br>
          ${r.note ? `<span style="color:#666; font-size:13px;">ğŸ“ ${r.note}</span>` : ''}
          ${r.repeat !== 'none' ? `<br><span style="color:#2196F3; font-size:12px;">ğŸ” ${getRepeatText(r.repeat)}</span>` : ''}
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px; min-width:80px;">
          ${!r.done ? `<button class="snooze-btn" onclick="quickSnooze(${r.id}, 5)">+5Ø¯Ù‚</button>` : ''}
          ${!r.done ? `<button class="done-btn" onclick="markAsDone(${r.id})">âœ“ ØªÙ…</button>` : ''}
          <button class="edit" onclick="editReminder(${r.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="delete" onclick="del(${r.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>`;
  }

  if (html === '') {
    list.innerHTML = `
      <div class="empty-state">
        <i>ğŸ“­</i>
        <p>${searchTerm ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†'}</p>
        ${!searchTerm ? `<button class="main-btn" onclick="switchTab('add')" style="background:var(--accent);color:white;border:none;padding:10px 20px;border-radius:10px;margin-top:15px;">
          â• Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ø£ÙˆÙ„
        </button>` : ''}
      </div>`;
  } else {
    list.innerHTML = html;
  }
  
  document.getElementById('totalReminders').textContent = total;
  document.getElementById('completedReminders').textContent = completed;
  document.getElementById('pendingReminders').textContent = pending;
}

// ============================================
// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
// ============================================
function getRepeatText(repeatValue) {
  const repeatTexts = {
    'none': '',
    'daily': 'ÙŠÙˆÙ…ÙŠ',
    'weekly': 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
    'daily-except-friday': 'ÙŠÙˆÙ…ÙŠ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©',
    'monthly-10th': 'ÙƒÙ„ Ø´Ù‡Ø± ÙŠÙˆÙ… 10'
  };
  return repeatTexts[repeatValue] || '';
}

// ============================================
// ØªØ¹Ù„ÙŠÙ… Ù…ÙˆØ¹Ø¯ ÙƒÙ…Ù†ØªÙ‡ÙŠ
// ============================================
async function markAsDone(id) {
  const reminder = reminders.find(r => r.id === id);
  if (reminder) {
    reminder.done = true;
    
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    await cancelScheduledNotification(id);
    
    try {
      await saveReminderToDB(reminder);
      showMessage("âœ“ ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙƒÙ…Ù†ØªÙ‡ÙŠ", 'success');
      show();
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", e);
      showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", 'error');
    }
  }
}

// ============================================
// ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯
// ============================================
function editReminder(id) {
  const reminder = reminders.find(r => r.id === id);
  if (!reminder) return;
  
  titleInput.value = reminder.title;
  noteInput.value = reminder.note || '';
  repeatSelect.value = reminder.repeat || 'none';
  categorySelect.value = reminder.category || 'other';
  
  const dateTime = new Date(reminder.time);
  const year = dateTime.getFullYear();
  const month = String(dateTime.getMonth() + 1).padStart(2, '0');
  const day = String(dateTime.getDate()).padStart(2, '0');
  const hours = String(dateTime.getHours()).padStart(2, '0');
  const minutes = String(dateTime.getMinutes()).padStart(2, '0');
  
  dateInput.value = `${year}-${month}-${day}`;
  timeInput.value = `${hours}:${minutes}`;
  
  if (reminder.sound) {
    if (typeof reminder.sound === 'string' && reminder.sound.startsWith('')) {
      recordedAudio = reminder.sound;
      selectedRingtone = null;
    } else if (typeof reminder.sound === 'object') {
      selectedRingtone = reminder.sound;
      recordedAudio = null;
      
      document.querySelectorAll('.ringtone-item').forEach((item, index) => {
        if (defaultRingtones[index] && 
            defaultRingtones[index].name === reminder.sound.name) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
  }
  
  editingReminderId = id;
  addUpdateBtn.textContent = "âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯";
  addUpdateBtn.className = "main-btn";
  
  switchTab('add');
}

// ============================================
// ØºÙÙˆØ© Ø³Ø±ÙŠØ¹Ø©
// ============================================
async function quickSnooze(id, minutes) {
  const reminder = reminders.find(r => r.id === id);
  if (!reminder) return;
  
  const newTime = new Date(reminder.time);
  newTime.setMinutes(newTime.getMinutes() + minutes);
  reminder.time = formatLocalDateTime(newTime);
  reminder.done = false;
  
  try {
    await saveReminderToDB(reminder);
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    await scheduleBackgroundNotification(reminder);
    showMessage(`â° ØªÙ… ØªØ£Ø¬ÙŠÙ„ "${reminder.title}" Ù„Ù…Ø¯Ø© ${minutes} Ø¯Ù‚Ø§Ø¦Ù‚`, 'success');
    show();
  } catch (e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", e);
    showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", 'error');
  }
}

// ============================================
// ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
// ============================================
function playSound(soundConfig, volume = 0.8) {
  try {
    initAudioContext();
    
    if (typeof soundConfig === 'string' && soundConfig.startsWith('')) {
      const audio = new Audio(soundConfig);
      audio.volume = volume;
      audio.play().catch(e => console.log("ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:", e));
      return audio;
    }
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    switch(soundConfig.type) {
      case 'beep':
        oscillator.type = 'sine';
        oscillator.frequency.value = soundConfig.freq || 800;
        gainNode.gain.value = volume;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + (soundConfig.duration || 0.3));
        break;
        
      case 'double-beep':
        oscillator.type = 'sine';
        oscillator.frequency.value = soundConfig.freq || 700;
        gainNode.gain.value = volume;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
        
        setTimeout(() => {
          try {
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.type = 'sine';
            osc2.frequency.value = soundConfig.freq || 700;
            gain2.gain.value = volume;
            osc2.start();
            osc2.stop(audioContext.currentTime + 0.1);
          } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©:", e);
          }
        }, 150);
        break;
        
      case 'triple-beep':
        oscillator.type = 'square';
        oscillator.frequency.value = soundConfig.freq || 500;
        gainNode.gain.value = volume * 0.7;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.08);
        
        setTimeout(() => {
          try {
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.type = 'square';
            osc2.frequency.value = soundConfig.freq || 500;
            gain2.gain.value = volume * 0.7;
            osc2.start();
            osc2.stop(audioContext.currentTime + 0.08);
          } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©:", e);
          }
        }, 100);
        
        setTimeout(() => {
          try {
            const osc3 = audioContext.createOscillator();
            const gain3 = audioContext.createGain();
            osc3.connect(gain3);
            gain3.connect(audioContext.destination);
            osc3.type = 'square';
            osc3.frequency.value = soundConfig.freq || 500;
            gain3.gain.value = volume * 0.7;
            osc3.start();
            osc3.stop(audioContext.currentTime + 0.08);
          } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©:", e);
          }
        }, 200);
        break;
        
      case 'sweep':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(soundConfig.startFreq || 400, audioContext.currentTime);
        oscillator.frequency.linearRampToValueAtTime(soundConfig.endFreq || 800, audioContext.currentTime + (soundConfig.duration || 0.4));
        gainNode.gain.value = volume * 0.6;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + (soundConfig.duration || 0.4));
        break;
        
      case 'click':
        oscillator.type = 'square';
        oscillator.frequency.value = soundConfig.freq || 900;
        gainNode.gain.value = volume * 0.4;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.05);
        break;
        
      case 'ring':
        oscillator.type = 'triangle';
        oscillator.frequency.value = soundConfig.freq || 650;
        gainNode.gain.value = volume * 0.5;
        
        const now = audioContext.currentTime;
        oscillator.start(now);
        
        gainNode.gain.setValueAtTime(volume * 0.5, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + (soundConfig.duration || 1.0));
        
        oscillator.stop(now + (soundConfig.duration || 1.0));
        break;
        
      default:
        oscillator.type = 'sine';
        oscillator.frequency.value = 800;
        gainNode.gain.value = volume;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
    }
    
    const stopSound = () => {
      try {
        oscillator.stop();
      } catch (e) {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      }
    };
    
    return { stop: stopSound };
    
  } catch (e) {
    console.error("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
    return null;
  }
}

// ============================================
// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…
// ============================================
function speakReminder(text) {
  try {
    if ('speechSynthesis' in window) {
      // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø³Ø§Ø¨Ù‚
      window.speechSynthesis.cancel();
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¨Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
      const utterance = new SpeechSynthesisUtterance(`Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯: ${text}`);
      
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      utterance.lang = 'ar-SA';
      
      // ØªØ¹ÙŠÙŠÙ† Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒÙ„Ø§Ù…
      utterance.rate = 0.9;
      
      // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù…
      window.speechSynthesis.speak(utterance);
    }
  } catch (e) {
    console.error("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù…:", e);
  }
}

// ============================================
// ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
// ============================================
function playFallbackSound() {
  try {
    initAudioContext();
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.value = 800;
    gainNode.gain.value = 0.2;
    
    oscillator.start();
    
    gainNode.gain.exponentialRampToValueAtTime(
      0.001, audioContext.currentTime + 0.5
    );
    
    oscillator.stop(audioContext.currentTime + 0.5);
  } catch (e) {
    console.error("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:", e);
  }
}

// ============================================
// ØªÙ‡ÙŠØ¦Ø© Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØª
// ============================================
function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}

// ============================================
// Ø­Ø°Ù ØªØ°ÙƒÙŠØ±
// ============================================
async function del(id) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ")) {
    try {
      // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
      await cancelScheduledNotification(id);
      
      await deleteReminderFromDB(id);
      reminders = reminders.filter(r => r.id !== id);
      showMessage("âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", 'success');
      
      if (document.getElementById('pageList').classList.contains('active')) {
        show();
      }
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", e);
      showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù", 'error');
    }
  }
}

// ============================================
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
// ============================================
async function checkMissedReminders() {
  if (isCheckingMissed) return;
  isCheckingMissed = true;
  
  const now = new Date();
  const lastCheck = localStorage.getItem("lastCheckTime");
  let missedCount = 0;
  
  if (lastCheck) {
    const lastCheckTime = new Date(lastCheck);
    
    for (const r of reminders) {
      if (!r.done) {
        const target = new Date(r.time);
        if (target > lastCheckTime && target <= now) {
          missedCount++;
          
          if (r.sound) {
            try {
              initAudioContext();
              playSound(r.sound, 0.8);
              
              if (navigator.vibrate) {
                navigator.vibrate([300, 200, 300]);
              }
              
              speakReminder(r.title);
            } catch (e) {
              console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
              playFallbackSound();
            }
          } else {
            playFallbackSound();
          }
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
          showAppNotification("â° ÙØ§ØªÙƒ Ù…ÙˆØ¹Ø¯!", {
            body: `ÙØ§ØªÙƒ Ù…ÙˆØ¹Ø¯: ${r.title}\nÙƒØ§Ù† Ù…Ù‚Ø±Ø±Ù‹Ø§ ÙÙŠ: ${formatDateArabic(new Date(r.time))}`,
            icon: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
            badge: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
            requireInteraction: true,
            silent: false
          });
          
          if (r.repeat !== "none") {
            const next = new Date(target);
            
            if (r.repeat === "daily") {
              next.setDate(next.getDate() + 1);
            } else if (r.repeat === "weekly") {
              next.setDate(next.getDate() + 7);
            } else if (r.repeat === "daily-except-friday") {
              next.setDate(next.getDate() + 1);
              if (next.getDay() === 5) {
                next.setDate(next.getDate() + 1);
              }
            } else if (r.repeat === "monthly-10th") {
              next.setMonth(next.getMonth() + 1);
              next.setDate(10);
            }
            
            r.time = formatLocalDateTime(next);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±
            await scheduleBackgroundNotification(r);
          } else {
            r.done = true;
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
            await cancelScheduledNotification(r.id);
          }
          
          try {
            await saveReminderToDB(r);
          } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯:", e);
          }
        }
      }
    }
    
    if (missedCount > 0) {
      setTimeout(() => {
        alert(`âš ï¸ ÙØ§ØªÙƒ ${missedCount} Ù…ÙˆØ¹Ø¯${missedCount > 1 ? 'Ø§Øª' : ''} Ø£Ø«Ù†Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.\nØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.`);
      }, 300);
    }
  }
  
  localStorage.setItem("lastCheckTime", now.toISOString());
  isCheckingMissed = false;
  show();
}

// ============================================
// ÙƒØ´Ù ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨
// ============================================
document.addEventListener('visibilitychange', () => {
  isTabActive = !document.hidden;
  
  if (isTabActive && !isCheckingMissed) {
    setTimeout(checkMissedReminders, 500);
  }
});

// ============================================
// Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…Ø­Ø¯Ø«Ø©)
// ============================================
async function requestNotificationPermission() {
  if ("Notification" in window) {
    try {
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ banner
      permissionBanner.classList.remove('active');
      
      if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        const permission = await Notification.requestPermission();
        
        if (permission === "granted") {
          showMessage("âœ“ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", 'success');
          localStorage.setItem('notificationPermissionRequested', 'true');
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Service Worker
          updateSWStatus();
          
          // Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          for (const reminder of reminders) {
            if (!reminder.done) {
              await scheduleBackgroundNotification(reminder);
            }
          }
        } else {
          showMessage("âš ï¸ ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. Ù„Ù† ØªØªÙ„Ù‚Ù‰ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.", 'warning');
        }
      } else if (Notification.permission === "granted") {
        showMessage("âœ“ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§", 'success');
      }
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", e);
      showMessage("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©", 'error');
    }
  }
}

// ============================================
// ØªØ³Ø¬ÙŠÙ„ Service Worker
// ============================================
async function registerServiceWorker() {
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    try {
      // Ø¥Ù†Ø´Ø§Ø¡ Service Worker Ù…Ù† ÙƒÙˆØ¯ ÙƒÙ€ Blob
      const swCode = `
        self.addEventListener('install', (event) => {
          self.skipWaiting();
          console.log('Service Worker ØªÙ… ØªØ«Ø¨ÙŠØªÙ‡');
        });

        self.addEventListener('activate', (event) => {
          event.waitUntil(clients.claim());
          console.log('Service Worker Ø£ØµØ¨Ø­ Ù†Ø´Ø·Ù‹Ø§');
        });

        self.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'SCHEDULE_NOTIFICATION') {
            const scheduled = event.data.data;
            console.log('Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø´Ø¹Ø§Ø±:', scheduled);
            
            // Ø­ÙØ¸ ÙÙŠ IndexedDB Ù„Ù„Ù€ Service Worker
            // (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù†Ø³ØªØ®Ø¯Ù… IndexedDB Ù‡Ù†Ø§)
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout (ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
            const now = Date.now();
            const delay = scheduled.triggerTime - now;
            
            if (delay > 0 && delay < 24 * 60 * 60 * 1000) { // Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©
              setTimeout(() => {
                showNotification(scheduled);
              }, delay);
            }
          } else if (event.data && event.data.type === 'CANCEL_NOTIFICATION') {
            console.log('Ø¥Ù„ØºØ§Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', event.data.id);
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
          } else if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
            showNotification({
              title: event.data.title,
              body: event.data.options.body,
              icon: event.data.options.icon,
              badge: event.data.options.badge,
              requireInteraction: event.data.options.requireInteraction,
              silent: event.data.options.silent
            });
          }
        });

        function showNotification(scheduled) {
          const title = scheduled.title || scheduled;
          const options = {
            body: scheduled.body || '',
            icon: scheduled.icon || 'https://cdn-icons-png.flaticon.com/512/2910/2910762.png',
            badge: scheduled.badge || 'https://cdn-icons-png.flaticon.com/512/2910/2910762.png',
            requireInteraction: scheduled.requireInteraction || false,
            silent: scheduled.silent || false,
            data: {
              reminderId: scheduled.reminderId,
              repeat: scheduled.repeat
            }
          };
          
          self.registration.showNotification(title, options);
        }

        self.addEventListener('notificationclick', (event) => {
          event.notification.close();
          
          event.waitUntil(
            clients.matchAll({type: 'window'}).then((clientList) => {
              for (const client of clientList) {
                if (client.url === '/' && 'focus' in client) {
                  return client.focus();
                }
              }
              if (clients.openWindow) {
                return clients.openWindow('/');
              }
            })
          );
        });

        self.addEventListener('push', (event) => {
          console.log('Push event received');
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù€ Push Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
        });
      `;
      
      // Ø¥Ù†Ø´Ø§Ø¡ Blob
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const swURL = URL.createObjectURL(blob);
      
      // ØªØ³Ø¬ÙŠÙ„ Service Worker
      swRegistration = await navigator.serviceWorker.register(swURL, {scope: '/'});
      
      console.log('Service Worker Ù…Ø³Ø¬Ù„:', swRegistration.scope);
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
      updateSWStatus();
      
      // Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ù†Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        setTimeout(() => {
          if (!localStorage.getItem('installPromptShown')) {
            installBanner.classList.add('active');
            localStorage.setItem('installPromptShown', 'true');
          }
        }, 5000);
      });
      
      // Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­
      window.addEventListener('appinstalled', () => {
        installBanner.classList.remove('active');
        deferredPrompt = null;
        showMessage("âœ“ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„.", 'success');
      });
      
    } catch (error) {
      console.error('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
      updateSWStatus(false);
    }
  } else {
    console.log('Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
    updateSWStatus(false);
  }
}

// ============================================
// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Service Worker ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
// ============================================
function updateSWStatus(isActive = true) {
  if (isActive && swRegistration) {
    swStatus.innerHTML = `
      <span class="sw-active">
        âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø·! Ø³ØªØªÙ„Ù‚Ù‰ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      </span>
    `;
    
    // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙØ·Ù„Ø¨ Ø¨Ø¹Ø¯
    if (!notificationPermissionRequested && Notification.permission !== 'granted') {
      setTimeout(() => {
        permissionBanner.classList.add('active');
      }, 3000);
    }
  } else {
    swStatus.innerHTML = `
      <span class="sw-inactive">
        âš ï¸ Service Worker ØºÙŠØ± Ù†Ø´Ø·. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù† ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
        ${isSecureContext ? 'Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.' : 'ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.'}
      </span>
    `;
  }
}

// ============================================
// ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================
function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
      }
      deferredPrompt = null;
      installBanner.classList.remove('active');
    });
  } else {
    showMessage("â„¹ï¸ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª", 'info');
  }
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³Ø±ÙŠØ¹
// ============================================
function updateTimerDisplay() {
  const hours = Math.floor(timerRemaining / 3600000);
  const minutes = Math.floor((timerRemaining % 3600000) / 60000);
  const seconds = Math.floor((timerRemaining % 60000) / 1000);
  
  timerDisplay.textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
  if (isTimerRunning) return;
  
  const hours = parseInt(timerHours.value) || 0;
  const minutes = parseInt(timerMinutes.value) || 0;
  const seconds = parseInt(timerSeconds.value) || 0;
  
  if (hours === 0 && minutes === 0 && seconds === 0) {
    showMessage("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±", 'error');
    return;
  }
  
  timerRemaining = (hours * 3600 + minutes * 60 + seconds) * 1000;
  
  if (timerRemaining <= 0) {
    showMessage("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª ØµØ§Ù„Ø­", 'error');
    return;
  }
  
  isTimerRunning = true;
  timerStartBtn.innerHTML = "â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  timerStartBtn.classList.remove("start");
  timerStartBtn.classList.add("pause");
  timerPauseBtn.disabled = false;
  timerResetBtn.disabled = true;
  
  timerHours.disabled = true;
  timerMinutes.disabled = true;
  timerSeconds.disabled = true;
  
  timerInterval = setInterval(() => {
    timerRemaining -= 1000;
    
    if (timerRemaining <= 0) {
      clearInterval(timerInterval);
      timerRemaining = 0;
      isTimerRunning = false;
      
      triggerTimerAlarm();
      
      timerStartBtn.innerHTML = "â–¶ï¸ Ø§Ø¨Ø¯Ø£";
      timerStartBtn.classList.remove("pause");
      timerStartBtn.classList.add("start");
      timerPauseBtn.disabled = true;
      timerResetBtn.disabled = false;
      timerHours.disabled = false;
      timerMinutes.disabled = false;
      timerSeconds.disabled = false;
      updateTimerDisplay();
      return;
    }
    
    updateTimerDisplay();
  }, 1000);
}

function pauseTimer() {
  if (!isTimerRunning) return;
  
  clearInterval(timerInterval);
  isTimerRunning = false;
  timerStartBtn.innerHTML = "â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù";
  timerStartBtn.classList.remove("pause");
  timerStartBtn.classList.add("start");
  timerPauseBtn.disabled = true;
  timerResetBtn.disabled = false;
}

function resetTimer() {
  clearInterval(timerInterval);
  isTimerRunning = false;
  
  timerHours.value = 0;
  timerMinutes.value = 1;
  timerSeconds.value = 0;
  timerRemaining = 60000;
  
  timerStartBtn.innerHTML = "â–¶ï¸ Ø§Ø¨Ø¯Ø£";
  timerStartBtn.classList.remove("pause");
  timerStartBtn.classList.add("start");
  timerPauseBtn.disabled = true;
  timerResetBtn.disabled = false;
  timerHours.disabled = false;
  timerMinutes.disabled = false;
  timerSeconds.disabled = false;
  
  updateTimerDisplay();
}

function triggerTimerAlarm() {
  try {
    initAudioContext();
    playSound(defaultRingtones[0], 0.8);
    
    if (navigator.vibrate) {
      navigator.vibrate([1000, 500, 1000]);
    }
    
    timerResetBtn.classList.add("alarm-active");
    setTimeout(() => {
      timerResetBtn.classList.remove("alarm-active");
    }, 5000);
  } catch (e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…Ù†Ø¨Ù‡:", e);
    playFallbackSound();
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  showAppNotification("â° Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ", {
    body: "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ!",
    icon: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
    badge: "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
    requireInteraction: true,
    silent: false
  });
  
  speakReminder("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ");
  
  showMessage("â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ! Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯", 'success');
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
// ============================================
function updateStopwatchDisplay() {
  const totalSeconds = Math.floor(stopwatchElapsedTime / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const milliseconds = Math.floor((stopwatchElapsedTime % 1000) / 10);
  
  stopwatchDisplay.textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
}

function startStopwatch() {
  if (isStopwatchRunning) return;
  
  isStopwatchRunning = true;
  stopwatchStartTime = Date.now() - stopwatchElapsedTime;
  
  stopwatchInterval = setInterval(() => {
    stopwatchElapsedTime = Date.now() - stopwatchStartTime;
    updateStopwatchDisplay();
  }, 10);
  
  stopwatchStartBtn.innerHTML = "â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  stopwatchStartBtn.classList.remove("start");
  stopwatchStartBtn.classList.add("pause");
  stopwatchPauseBtn.disabled = false;
  stopwatchResetBtn.disabled = true;
  stopwatchLapBtn.disabled = false;
}

function pauseStopwatch() {
  if (!isStopwatchRunning) return;
  
  clearInterval(stopwatchInterval);
  isStopwatchRunning = false;
  
  stopwatchStartBtn.innerHTML = "â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù";
  stopwatchStartBtn.classList.remove("pause");
  stopwatchStartBtn.classList.add("start");
  stopwatchPauseBtn.disabled = true;
  stopwatchResetBtn.disabled = false;
  stopwatchLapBtn.disabled = true;
}

function resetStopwatch() {
  clearInterval(stopwatchInterval);
  isStopwatchRunning = false;
  stopwatchElapsedTime = 0;
  laps = [];
  
  stopwatchStartBtn.innerHTML = "â–¶ï¸ Ø§Ø¨Ø¯Ø£";
  stopwatchStartBtn.classList.remove("pause");
  stopwatchStartBtn.classList.add("start");
  stopwatchPauseBtn.disabled = true;
  stopwatchResetBtn.disabled = false;
  stopwatchLapBtn.disabled = true;
  lapsContainer.innerHTML = '';
  
  updateStopwatchDisplay();
}

function lapStopwatch() {
  if (!isStopwatchRunning) return;
  
  const lapTime = new Date(stopwatchElapsedTime).toISOString().substr(11, 11);
  laps.unshift(lapTime);
  
  if (laps.length > 10) {
    laps.pop();
  }
  
  renderLaps();
}

function renderLaps() {
  lapsContainer.innerHTML = '';
  
  laps.forEach((lap, index) => {
    const lapItem = document.createElement('div');
    lapItem.className = 'lap-item';
    lapItem.innerHTML = `
      <span>Ù„ÙÙ‘Ø© ${laps.length - index}</span>
      <span class="lap-time">${lap}</span>
    `;
    lapsContainer.appendChild(lapItem);
  });
}

function setTimerFromStopwatch() {
  if (stopwatchElapsedTime <= 0) {
    showMessage("âš ï¸ Ø§Ø¨Ø¯Ø£ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª", 'error');
    return;
  }
  
  const totalSeconds = Math.floor(stopwatchElapsedTime / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  switchTab('timer');
  
  timerHours.value = hours;
  timerMinutes.value = minutes;
  timerSeconds.value = seconds;
  timerRemaining = stopwatchElapsedTime;
  
  updateTimerDisplay();
  showMessage(`âœ“ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ù‡ Ù„Ù…Ø¯Ø© ${hours}Ø³ ${minutes}Ø¯ ${seconds}Ø«`, 'success');
}

// ============================================
// ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
// ============================================
function exportReminders() {
  try {
    const exportData = reminders.map(r => {
      const { id, ...rest } = r;
      return {
        ...rest,
        exportId: id,
        exportDate: new Date().toISOString()
      };
    });
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'reminders-backup-' + new Date().toISOString().slice(0,10) + '.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showMessage("âœ“ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­", 'success');
  } catch (e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:", e);
    showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±", 'error');
  }
}

// ============================================
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
// ============================================
async function importReminders(input) {
  if (input.files && input.files[0]) {
    try {
      const file = input.files[0];
      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          const importedReminders = JSON.parse(e.target.result);
          
          if (!Array.isArray(importedReminders)) {
            throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
          }
          
          let importedCount = 0;
          for (const rem of importedReminders) {
            if (rem.done && new Date(rem.time) < new Date(Date.now() - 7*24*60*60*1000)) {
              continue;
            }
            
            const newReminder = {
              id: Date.now() + Math.floor(Math.random() * 10000),
              title: rem.title || 'Ù…ÙˆØ¹Ø¯ Ù…Ø³ØªÙˆØ±Ø¯',
              time: rem.time || formatLocalDateTime(new Date(Date.now() + 60000)),
              note: rem.note || '',
              sound: rem.sound || defaultRingtones[0],
              repeat: rem.repeat || 'none',
              category: rem.category || 'other',
              done: rem.done || false
            };
            
            reminders.push(newReminder);
            await saveReminderToDB(newReminder);
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            if (!newReminder.done) {
              await scheduleBackgroundNotification(newReminder);
            }
            
            importedCount++;
          }
          
          input.value = '';
          showMessage(`âœ“ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
          show();
        } catch (e) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:", e);
          showMessage("âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù", 'error');
        }
      };
      
      reader.readAsText(file);
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", e);
      showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯", 'error');
    }
  }
}

// ============================================
// ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
// ============================================
function filterReminders() {
  show();
}

// ============================================
// ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„ØªØ±
// ============================================
function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  show();
}

// ============================================
// ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ±ØªÙŠØ¨
// ============================================
function setSort(sortType) {
  currentSort = sortType;
  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  show();
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØºÙÙˆØ©
// ============================================
function snoozeReminder(minutes) {
  if (!snoozingReminder) return;
  
  const newTime = new Date(snoozingReminder.time);
  newTime.setMinutes(newTime.getMinutes() + minutes);
  snoozingReminder.time = formatLocalDateTime(newTime);
  snoozingReminder.done = false;
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«
  saveReminderToDB(snoozingReminder);
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  scheduleBackgroundNotification(snoozingReminder);
  
  closeSnoozeModal();
  
  showMessage(`â° ØªÙ… ØªØ£Ø¬ÙŠÙ„ "${snoozingReminder.title}" Ù„Ù…Ø¯Ø© ${minutes} Ø¯Ù‚Ø§Ø¦Ù‚`, 'success');
  
  show();
}

function closeSnoozeModal() {
  snoozeModal.style.display = 'none';
  snoozingReminder = null;
  
  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø§Ù‡ØªØ²Ø§Ø²
  if (navigator.vibrate) {
    navigator.vibrate(0);
  }
}

// ============================================
// Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
// ============================================
async function init() {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¢Ù…Ù†
  const isSecureContext = window.isSecureContext || window.location.hostname === 'localhost';
  
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  
  now.setMinutes(now.getMinutes() + 1);
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  
  dateInput.value = `${year}-${month}-${day}`;
  timeInput.value = `${hours}:${minutes}`;
  dateInput.min = `${year}-${month}-${day}`;
  
  updateMinTime();
  
  loadDefaultRingtones();
  
  // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù€ banner Ù„Ø§Ø­Ù‚Ù‹Ø§)
  if (!notificationPermissionRequested) {
    // Ù„Ø§ Ù†Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø¨Ù„ Ù†Ø¹Ø±Ø¶ Ø¨Ù†Ø± Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
  }
  
  if (!localStorage.getItem("lastCheckTime")) {
    localStorage.setItem("lastCheckTime", now.toISOString());
  }
  
  try {
    await initDatabase();
    reminders = await loadRemindersFromDB();
    console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:", reminders.length);
  } catch (e) {
    console.error("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
    showMessage("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ.", 'warning');
    reminders = JSON.parse(localStorage.getItem("reminders")) || [];
  }
  
  // ØªØ³Ø¬ÙŠÙ„ Service Worker
  await registerServiceWorker();
  
  setTimeout(checkMissedReminders, 1000);
  
  setInterval(() => {
    if (isTabActive) {
      show();
      localStorage.setItem("lastCheckTime", new Date().toISOString());
    }
  }, 10000);
  
  updateTimerDisplay();
  updateStopwatchDisplay();
  
  dateInput.addEventListener('change', updateMinTime);
  
  document.body.addEventListener('click', initAudioContext, { once: true });
  
  window.addEventListener('click', (e) => {
    if (e.target === snoozeModal) {
      closeSnoozeModal();
    }
  });
  
  show();
}

// ============================================
// Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
// ============================================
window.addEventListener('beforeunload', (e) => {
  if (recording) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// ============================================
// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================
window.addEventListener('DOMContentLoaded', init);
</script>

<script>
// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
const manifest = {
  "name": "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„",
  "short_name": "ØªØ°ÙƒÙŠØ±",
  "description": "ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¨ÙŠ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#667eea",
  "theme_color": "#667eea",
  "icons": [
    {
      "src": "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "https://cdn-icons-png.flaticon.com/512/2910/2910762.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "permissions": ["notifications"]
};

// Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· manifest
const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
</script>

</body>
</html>

